#!/bin/bash

set -ex

VERSION=`./bin/version`
NODE_VERSION=7.5.0

if [ $# -ne 1 ]; then
  echo "USAGE: ./bin/build PLATFORM"
  exit 1
fi

PLATFORM=$1

# setup workspace
HEROKU_BASE=heroku-v$VERSION-$PLATFORM
WORKSPACE=tmp/build/$HEROKU_BASE
rm -rf $WORKSPACE
mkdir -p $WORKSPACE/node_modules
cp README.md $WORKSPACE
cp LICENSE $WORKSPACE
cp package.json $WORKSPACE
cp yarn.lock $WORKSPACE
cp cli.js $WORKSPACE
cp -r lib $WORKSPACE

# install node
NODE_BASE=node-v$NODE_VERSION-$PLATFORM
if [ ! -f tmp/$NODE_BASE.tar.gz ]; then
  curl -fSLo tmp/$NODE_BASE.tar.gz https://nodejs.org/dist/v$NODE_VERSION/$NODE_BASE.tar.gz
fi
tar -C $WORKSPACE -xf tmp/$NODE_BASE.tar.gz
mv $WORKSPACE/$NODE_BASE $WORKSPACE/node

# install packages
cd $WORKSPACE
yarn install --offline --no-progress --production

echo $VERSION > VERSION

# create bin runner
cat << EOF > heroku
#!/bin/bash
DIR="\$( cd "\$( dirname "\${BASH_SOURCE[0]}" )" && pwd )"
\$DIR/node/bin/node --harmony-async-await --use_strict \$DIR/cli.js \$*
EOF
chmod +x heroku

# create tarball
cd ..
tar czf $HEROKU_BASE.tar.gz $HEROKU_BASE

SHA256=`shasum -a 256 $HEROKU_BASE.tar.gz | awk {'print \$1'}`
cat << EOF > $PLATFORM
{
  "version": "$VERSION",
  "sha256": "$SHA256"
}
EOF

cd ../..
