#!/bin/bash

set -ex

VERSION=`./bin/version`

if [ $# -ne 1 ]; then
  echo "USAGE: ./bin/release CHANNEL"
  exit 1
fi

CHANNEL=$1

function release {
  ./bin/build $PLATFORM
  aws s3 cp --cache-control max-age=86400 tmp/build/heroku-v$VERSION-$PLATFORM.tar.xz s3://heroku-cli-assets/branches/$CHANNEL/heroku-v$VERSION-$PLATFORM.tar.xz
  aws s3 cp --cache-control max-age=86400 tmp/build/heroku-v$VERSION-$PLATFORM.tar.gz s3://heroku-cli-assets/branches/$CHANNEL/heroku-v$VERSION-$PLATFORM.tar.gz
  aws s3 cp --cache-control max-age=86400 tmp/build/heroku-v$VERSION-$PLATFORM.tar.xz s3://heroku-cli-assets/branches/$CHANNEL/heroku-$PLATFORM.tar.xz
  aws s3 cp --cache-control max-age=86400 tmp/build/heroku-v$VERSION-$PLATFORM.tar.gz s3://heroku-cli-assets/branches/$CHANNEL/heroku-$PLATFORM.tar.gz
}

pids=""
RESULT=0

for PLATFORM in `./bin/platforms`; do
  release &
  pids="$pids $!"
  sleep 3
done

for pid in $pids; do
  wait $pid || let "RESULT=1"
done

if [ $RESULT -ne 0 ]; then
  exit $RESULT
fi
